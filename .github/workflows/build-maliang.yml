name: Build and Push Maliang Image

on:
  workflow_dispatch:  # 允许手动点击按钮触发构建

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 关键步骤：下载 JAR 包 (因为源码里没有)
      # 这里的 URL 需要替换为最新的 Release 下载链接
      # 目录结构参考源文件 [3]: deploy/dist/ainovel-server.jar
      - name: Download JAR file
        run: |
          mkdir -p deploy/dist
          # 下面的链接是 v1.0.0 版本的示例，请去 Release 页面确认最新链接
          wget -O deploy/dist/ainovel-server.jar https://github.com/Deng-m1/MaliangAINovalWriter/releases/download/v1.0.0/ainovel.jar
          echo "JAR file downloaded successfully."

      # 3. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 设置构建环境 (QEMU)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      # 5. 设置构建工具 (Buildx)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 6. 构建并推送
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          # 指定 Dockerfile 路径，参考源文件 [3]
          file: deploy/open/Dockerfile
          push: true
          # 强制指定架构为 amd64，确保群晖能跑
          platforms: linux/amd64
          # 镜像标签：您的用户名/镜像名:版本号
          tags: ${{ secrets.DOCKER_USERNAME }}/maliang-writer:v1.0.0
